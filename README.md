# Go-there

[![Go Report Card](https://goreportcard.com/badge/github.com/Fraise/go-there)](https://goreportcard.com/report/github.com/Fraise/go-there)

Go-there is a simple, yet configurable, URL shortener. The end goal is to create a simple and coherent API that can be
used easily by any front-end application.

Go-there aims at being decently fast, be able to use the commonly used database and cache, as well as having proper
logging and monitoring out of the box.

It is currently a work in progress, and the API should not be considered stable before version 1.0.

## Installation
### Binary

To create a binary of go-there, you will need to first install the [latest Go binary SDK](https://golang.org/dl/) then
compile it by running `make` (or `make build-static` is you want a statically linked binary).

You will need to set up a database (currently only mysql is supported) with the schema described 
[here](.test/db/go-there.sql) and add the settings to the go-there configuration file.

A cache layer is also recommended for faster operation. You can set up a local and networking cache using Redis, then
add the settings to the go-there configuration file. For low usage servers, the local cache should be enough.

A description of the configuration options can be found in the [Configuration section](#Configuration).
Most of them need to be setup for the server to work. You can also find examples 
[in the .examples folder](https://github.com/Fraise/go-there/tree/master/.examples).

### Docker

*WIP*

## API

You can find the API documentation on [this page](https://fraise.github.io/go-there/).

## Authentication

The authentication is handled by the `auth` middleware. It can be enabled per service as described in the 
[Configuration](#Configuration) section. A user can use a username/password combination (basic auth), an API key or an 
authentication token.

### Examples

The username/password can be provided in the [basic auth format](https://en.wikipedia.org/wiki/Basic_access_authentication)
as a request header:

```http request
Authorization: Basic YWxpY2U6c2VjcmV0cGFzc3dvcmQ=
```

The API key can be provided in a `X-Api-Key` header:

```http request
X-Api-Key: bi44RkM4YWwueFE0d2RvTkF5akpJTzpPSC1rbkdMcm91VlA3N01pZkJ1Y0F3PT0=
```

The authentication token can be provided in an `X-Auth-Token` header :

```http request
X-Auth-Token: eyJ0b2tlbiI6IlFuc1llRE00aGZZS0wtdUFQamZOTVZMNGNUWV[...]saWNlX2dlbiJ9
```

If multiple authentication methods are used at the same time, the validation order is : auth token, API key,
basic auth. Only the first one found will be parsed.


### Generate credentials

The username/password combination is the one provided at user creation. When a user is created, the response will
contain the user's API key. If it's lost, a new one can be generated by sending a `PATCH` request on */api/:user* with
the field **"new_api_key"** set to **true**.

An authentication token can be generated or regenerated by sending a `GET` on */api/auth*. The user must exist and be
authenticated.

***Do not use the example API key anywhere, even for testing purpose!***

## Database

Currently, only MySQL is supported. The database schema is the following:

![Database schema](.images/db-schema.png)


## Configuration

The configuration uses the toml format.

### [Server]

`Mode` Set the server to debug or release mode. Set to "debug" for extra gin logging or "release" for production

`ListenAddress` The ip address the application listen to, formatted as "0.0.0.0"

`HttpListenPort` Port used by the application for http calls

`HttpsListenPort` Port used by the application for https calls

`UseAutoCert` Use Let's encrypt autocert to get a SSL certificate for the configured domains

`Domains` Must be set if using autocert. This is the list of the allowed domains. The domains should be exact matches 
and cannot use regexes or wildcards

`CertCache` Should be set if using autocert. Specifies the cache directory for the certificates fetched. If it does not 
exist, it is created

`CertPath` Path to a manually provided certificate. Is ignored if `UseAutoCert` is set to `true`

`KeyPath` Path to a manually provided server key. Is ignored if `UseAutoCert` is set to `true`

### [Endpoints]

All endpoints can be configured using the array of values :

```toml
endpoint={ Enabled=true, Auth=false, AdminOnly=false, Log=true }
```

The available configuration groups are :

`health` represents the */health* endpoint

`create_users` represents the user creation method and endpoint: `POST` on */api/users*

`manage_users` represents the user management endpoint: `GET`, `DELETE` and `PATCH` on */api/:user*

`get_user_list` represents the user list endpoint: `GET` on */api/users*

`go` represents the redirection endpoint: `GET` on */go/:path*

`manage_path` represents the path management endpoint: `POST` and `DELETE` on */api/path*

`auth_token` represents the authentication token management endpoint: `GET` and `DELETE` on */api/auth*

### [UserRules]

Defines the rules applied when creating a new user. If no rule is provided, sane defaults are used.

`UsernameRegex` Regular expression used to validate usernames. It must be a full match. Defaults to `[a-z_][a-z0-9_-]*`

`UsernameMinLen` Minimum length of the username. No minimum if -1 is set. Defaults to 1

`UsernameMaxLen` Maximum length of the username. No maximum if -1 is set. Defaults to 24

`PasswordRegex` Regular expression used to validate passwords. It must be a full match. No validation by default

`PasswordMinLen` Minimum length of the password. No minimum if -1 is set. Defaults to 8

`PasswordMaxLen` Maximum length of the username. No maximum if -1 is set. Defaults to 64

### [Cache]

The cache supports both Redis and local cache. It is only used to cache redirection requests, and local and network
caching can be enabled at the same time. It currently only supports a single Redis instance.

`Enabled` Enable the Redis cache

`Type` Unused

`Address` Network address of the Redis instance

`Port` Port used by Redis

`User` Username used to connect to the Redis instance

`Password` Password used to connect to the Redis instance

`LocalCacheEnabled` Enable the local cache

`LocalCacheSize` Size of the cache (in number of path/target pair)

`LocalCacheTtlSec` Lifetime in seconds of the elements in the local cache

### [Database]

Currently, the supported database type is mysql. In the future, postgresql and sqlite should also be supported.

`Type` The database type: "mysql"

`Address` A string representing the address of the database. Can be a domain or IP

`Port` The port to connect to

`SslMode` Should SSL be used for the connection: *true* or *false*

`Protocol` The connection protocol to use

`Name` The name of the database

`User` The user to identify as for the connection

`Password` The password of the connection user

### [Logs]

Base logging is enabled for the base operations (initialization...) but request logging should be enabled on an endpoint
basis as described in the *[Endpoints]* section. The available options common to every endpoint are :

`File` The file where the logs will be appended. The `$stdout` and `$stderr` string will respectively output the logs in
the OS' stdout or stderr. The `$null` string will discard all log output. If left empty, it will output to stdout.

`AsJSON` Format the logs as a JSON string. If it is set to false, the logs will be formatted and colored for the 
console, so they will be difficult to parse in a file.